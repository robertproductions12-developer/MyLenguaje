<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binary Control Fix</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; text-align: center; }
        #console { background: #111; border: 1px solid #0f0; padding: 15px; height: 150px; overflow-y: auto; text-align: left; font-size: 0.8rem; margin-bottom: 20px; }
        #bin-display { font-size: 3rem; color: #fff; text-shadow: 0 0 10px #0f0; margin: 20px 0; min-height: 1em;}
        button { background: #0f0; color: #000; border: none; padding: 20px; width: 100%; font-weight: bold; border-radius: 10px; cursor: pointer; }
        .error { color: #f00; }
        .success { color: #0f0; }
    </style>
</head>
<body>

    <h2>BINARY_OS_DEBUG</h2>
    
    <div id="console">--- SYSTEM READY ---<br></div>
    
    <div id="bin-display"></div>

    <button id="btnAction">PRESIONAR PARA HABLAR</button>

    <div style="margin-top:20px; font-size: 0.7rem; color: #666;">
        Comandos: "01" (Vibrar), "11" (Hora), "00" (Cámara)
    </div>

    <script>
        const consoleLog = document.getElementById('console');
        const binDisplay = document.getElementById('bin-display');
        const btn = document.getElementById('btnAction');
        let currentCode = "";
        let isListening = false;

        // Función para escribir en la consola de la pantalla
        function log(msg, isError = false) {
            const span = document.createElement('div');
            span.className = isError ? 'error' : 'success';
            span.innerHTML = `> ${msg}`;
            consoleLog.appendChild(span);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        // 1. Verificar si el navegador soporta voz
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            log("ERROR: Tu navegador no soporta reconocimiento de voz.", true);
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.continuous = true; 
        recognition.interimResults = false;

        btn.onclick = () => {
            try {
                if (!isListening) {
                    recognition.start();
                    isListening = true;
                    btn.innerText = "ESCUCHANDO...";
                    btn.style.background = "#f00";
                    log("Micrófono activado. Di 'cero' o 'uno'.");
                } else {
                    recognition.stop();
                    isListening = false;
                    btn.innerText = "PRESIONAR PARA HABLAR";
                    btn.style.background = "#0f0";
                    log("Micrófono desactivado.");
                }
            } catch (e) {
                log("Error al iniciar: " + e.message, true);
            }
        };

        recognition.onresult = (event) => {
            const text = event.results[event.results.length - 1][0].transcript.toLowerCase();
            log("Escuchado: " + text);

            // Filtramos la entrada para detectar 0 y 1 en texto o número
            if (text.includes("cero") || text.includes("0")) {
                currentCode += "0";
            } 
            if (text.includes("uno") || text.includes("1")) {
                currentCode += "1";
            }

            binDisplay.innerText = currentCode;

            // Si llega a 2 dígitos, ejecuta y limpia
            if (currentCode.length >= 2) {
                ejecutarAccion(currentCode);
                currentCode = "";
                setTimeout(() => { binDisplay.innerText = ""; }, 2000);
            }
        };

        recognition.onerror = (event) => {
            log("ERROR DE RECONOCIMIENTO: " + event.error, true);
            if(event.error === 'not-allowed') {
                alert("Debes permitir el acceso al micrófono en los ajustes del navegador.");
            }
        };

        function ejecutarAccion(code) {
            log("EJECUTANDO COMANDO: " + code);
            if (code === "01") {
                log("Acción: VIBRAR");
                if (navigator.vibrate) navigator.vibrate(500);
            } else if (code === "11") {
                log("Acción: HORA");
                const h = new Date().toLocaleTimeString();
                const u = new SpeechSynthesisUtterance("Son las " + h);
                window.speechSynthesis.speak(u);
            } else if (code === "00") {
                log("Acción: CÁMARA");
                navigator.mediaDevices.getUserMedia({video: true})
                    .then(s => log("Cámara lista (Permiso concedido)"))
                    .catch(e => log("Error cámara: " + e.message, true));
            } else {
                log("Código " + code + " no definido.", true);
            }
        }
    </script>
</body>
</html>
